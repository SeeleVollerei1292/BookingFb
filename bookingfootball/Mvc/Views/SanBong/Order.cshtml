@model Mvc.Models.OrderViewModel
@{
    ViewData["Title"] = "Xác Nhận Đặt Sân";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<style>
    .card-custom {
        border-radius: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .table th, .table td {
        vertical-align: middle;
        text-align: center;
    }

    .highlight-title {
        font-weight: bold;
        color: #0d6efd;
        margin-bottom: 20px;
    }

    .btn-confirm {
        font-size: 1.2rem;
        padding: 10px 20px;
    }
</style>

<div class="container mt-5">
    <h2 class="text-center highlight-title">Xác Nhận Đặt Sân</h2>
    <div class="card card-custom p-4">
        <h4 class="highlight-title">Chi Tiết Đặt Sân</h4>
        <table class="table table-bordered" id="orderTable">
            <thead class="table-dark">
                <tr>
                    <th>Tên Sân</th>
                    <th>Giá</th>
                    <th>Ngày</th>
                    <th>Tên Ca</th>
                    <th>Giờ</th>
                    <th>Nước Uống</th>
                    <th>Đồ Thuê</th>
                    <th>Tổng Tiền</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var ca in Model.Booking.Cas)
                {
                    <tr>
                        <td>@Model.Booking.TenSan</td>
                        <td>@Model.Booking.Gia.ToString("N0") VNĐ/giờ</td>
                        <td>@ca.Date</td>
                        <td>@ca.TenCa</td>
                        <td>@ca.StartTime - @ca.EndTime</td>
                        <td>
                            @(ca.NuocUongSelections.Any()
                                                    ? string.Join(", ", ca.NuocUongSelections.Select(nu => $"{nu.TenNuocUong} (x{nu.Quantity})"))
                                                    : "Chưa chọn")
                                                              </td>
                                                              <td>
                            @(ca.DoThueSelections.Any()
                                                    ? string.Join(", ", ca.DoThueSelections.Select(dt => $"{dt.TenDoThue} (x{dt.Quantity})"))
                                                    : "Chưa chọn")
                    </td>
                    <td>
                        @{
                                var duration = (TimeSpan.Parse(ca.EndTime) - TimeSpan.Parse(ca.StartTime)).TotalHours;
                                var slotCost = (decimal)duration * Model.Booking.Gia; 
                                var nuocUongCost = ca.NuocUongSelections.Sum(nu => nu.GiaBan * nu.Quantity);
                                var doThueCost = ca.DoThueSelections.Sum(dt => dt.DonGia * dt.Quantity);
                                var totalCost = slotCost + nuocUongCost + doThueCost;
                            }
                            @totalCost.ToString("N0") VNĐ
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <div class="text-end mt-3">
            <h5>Tổng Tiền Tất Cả Ca: @Model.Booking.TongTien.ToString("N0") VNĐ</h5>
        </div>
    </div>

    <div class="card card-custom p-4 mt-4">
        <h4 class="highlight-title">Thông Tin Khách Hàng</h4>
        <form id="orderForm" action="@Url.Action("ConfirmOrder", "SanBong")" method="post">
            <input type="hidden" name="HoaDonId" value="@Model.HoaDonId" />
            <div class="mb-3">
                <label for="tenNguoiDat" class="form-label">Họ và Tên</label>
                <input type="text" class="form-control" id="tenNguoiDat" name="TenNguoiDat" value="@Model.TenNguoiDat" required />
            </div>
            <div class="mb-3">
                <label for="soDienThoai" class="form-label">Số Điện Thoại</label>
                <input type="tel" class="form-control" id="soDienThoai" name="SoDienThoaiNguoiDat" value="@Model.SoDienThoaiNguoiDat" required pattern="[0-9]{10}" />
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" name="Email" value="@Model.Email" required />
            </div>
            <div class="mb-3">
                <label for="ghiChu" class="form-label">Ghi Chú</label>
                <textarea class="form-control" id="ghiChu" name="GhiChu" rows="4">@Model.GhiChu</textarea>
            </div>
            <div class="text-end">
                <button type="submit" class="btn btn-primary btn-confirm">Xác Nhận Đặt Sân</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function () {
        $('#orderForm').on('submit', function (e) {
            e.preventDefault();
            var form = $(this);
            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: form.serialize(),
                 xhrFields: {
        withCredentials: true
    },
                success: function (response) {
                    if (response.success) {
                        alert(response.message);
                        window.location.href = response.redirectUrl;
                    } else {
                        alert(response.message);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('ConfirmOrder Error:', status, error);
                    alert('Đã xảy ra lỗi khi xác nhận đặt sân: ' + error);
                }
            });
        });
    });
</script>